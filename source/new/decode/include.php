<?

$GLOBALS['____1821209743'] = array(base64_decode('ZGV' . 'm' . 'aW' . '5l'), base64_decode('c3RycmV2'), base64_decode('c3R' . 'yd' . 'G91c' . 'HB' . 'lcg' . '=='), base64_decode('c3ByaW' . '5' . '0Zg=='), base64_decode('c' . '3ByaW50Zg=='), base64_decode('c3Vic3' . 'Ry'), base64_decode('c' . '3' . 'Rycm' . 'V2'), base64_decode('Ym' . 'FzZTY0X2RlY29' . 'kZQ=='), base64_decode('' . 'c3V' . 'ic3Ry'), base64_decode('c3' . 'R' . 'ybGVu'), base64_decode('c' . '3RybGVu'), base64_decode('Y2hy'), base64_decode('' . 'b' . '3' . 'Jk'), base64_decode('b3Jk'), base64_decode('bWt0a' . 'W' . '1' . 'l'), base64_decode('aW5' . '0dmFs'), base64_decode('aW50' . 'dmF' . 's'), base64_decode('' . 'aW50dmFs'), base64_decode('' . 'a3' . 'N' . 'vcnQ='), base64_decode('c3Vi' . 'c3Ry'), base64_decode('a' . 'W1wb' . 'G9kZ' . 'Q=='), base64_decode('ZGVmaW5lZA=='), base64_decode('YmFzZT' . 'Y0X' . '2RlY29kZQ=='), base64_decode('Y29uc3R' . 'hbnQ='), base64_decode('' . 'c3RycmV2'), base64_decode('' . 'c3B' . 'ya' . 'W' . '50' . 'Zg=='), base64_decode('c3RybGVu'), base64_decode('c3Ry' . 'bG' . 'Vu'), base64_decode('Y' . '2hy'), base64_decode('b3Jk'), base64_decode('' . 'b3Jk'), base64_decode('bWt0' . 'aW1l'), base64_decode('a' . 'W5' . '0dmFs'), base64_decode('a' . 'W50d' . 'mFs'), base64_decode('aW5' . '0' . 'dm' . 'Fs'), base64_decode('c3Vic3Ry'), base64_decode('c3V' . 'ic3' . 'R' . 'y'), base64_decode('dGlt' . 'ZQ=='), base64_decode('b' . 'W' . 't0aW1' . 'l'), base64_decode('bWt0' . 'a' . 'W1l'), base64_decode('ZGF0ZQ=='), base64_decode('' . 'ZGF0' . 'ZQ=='), base64_decode('ZGVma' . 'W' . '5' . 'l'), base64_decode('ZG' . 'VmaW5l'), base64_decode('cm' . '91bm' . 'Q='), base64_decode('dHJpb' . 'Q=='), base64_decode('dHJ' . 'p' . 'bQ=='), base64_decode('' . 'cm' . '91bmQ' . '='), base64_decode('dHJpbQ=='), base64_decode('d' . 'HJ' . 'pb' . 'Q=='), base64_decode('c3Vic3Ry'), base64_decode('' . 'bWJfY2' . '9udmVydF9lbm' . 'NvZG' . 'luZw=='), base64_decode('cm91bmQ='), base64_decode('' . 'cm91bmQ' . '='), base64_decode('cm91' . 'bmQ='), base64_decode('' . 'c3Vic3R' . 'y'), base64_decode('bWJfY29u' . 'dmVydF' . '9lb' . 'mNvZ' . 'G' . 'l' . 'uZ' . 'w' . '=='), base64_decode('' . 'cm' . '91' . 'bmQ='), base64_decode('c' . 'm91bmQ' . '='), base64_decode('cmV' . 'zZXQ='), base64_decode('aW50dm' . 'Fs'), base64_decode('c3R' . 'y' . 'bG' . 'Vu'), base64_decode('a' . '3NvcnQ' . '='), base64_decode('' . 'aW' . '1wb' . 'G9kZQ=='), base64_decode('YXJyYXlfdmF' . 's' . 'dWVz'), base64_decode('aGFza' . 'A=='), base64_decode('ZGVmaW5' . 'lZA' . '=='), base64_decode('c3RybG' . 'V' . 'u'));
/**
 * Copyright (c) 3/11/2019 Created By/Edited By ASDAFF asdaff.asad@yandex.ru
 */

if (!function_exists(__NAMESPACE__ . '\\___385691105')) {
    function ___385691105($_1813418007)
    {
        static $_2124549413 = false;
        if ($_2124549413 == false) $_2124549413 = array('ZXh' . 'wa' . 'XJl' . 'X21l' . 'c3N' . 'fY3VzdG' . '9' . 'tMg' . '=' . '=', '' . 'cm92' . 'ZXJfdG' . 'lua29mZl8' . '=', 'b' . '21lZA==', '' . 'WQ==', 'ZHJt' . 'X3N0Z' . 'X' . 'Jnb2tj', 'JTAxMHMK', 'ZX' . 'J' . 'fdGlu', 'c' . 'm92' . 'ZXIu' . 'dG' . 'lua2' . '9mZg==', 'JXMlcw==', 'fmJz', 'Z' . 'XRhZF9wbw' . '=' . '=', 'YWRtaW4=', 'bW9kd' . 'Wxlcw==', '' . 'dXN' . 'lcl9' . 'kYX' . 'Rl' . 'X2Jz' . 'b' . 'S5waHA' . '=', 'cm9' . '2Z' . 'XIudGlua29m' . 'Zg=' . '=', '' . 'Ym' . 'l0cml4', 'Ukhlcl90aW4=', 'NWE' . '1YjUyYT' . 'Bk' . 'NDhoeXRv' . 'cw==', '', 'NGVi', 'N2U' . 'zNzI0Y' . 'Tg5OTI5Y' . 'zE' . '4' . 'NjM' . 'x', 'NDI1MWMzNg' . '==', '' . 'aHR' . '0cDovL2JpdH' . 'JpeHN' . 'vZnQuY' . '29tL2J' . 'pdHJpe' . 'C9icy5waH' . 'A=', 'cm92', 'a29m' . 'Zl9PT' . 'E' . 'RTSVR' . 'FRVhQSV' . 'JFR' . 'EFURVM=', 'RE9DVU1FTl' . 'R' . 'fUk' . '9PVA==', 'Lw==', 'L' . 'w' . '==', 'cm92ZXJfdG' . 'l' . 'u' . 'a29' . 'm' . 'Zl' . '9' . 'URU1QT1JBUllfQ0' . 'F' . 'DSEU=', 'cm92ZXJf' . 'dGlua29' . 'mZl9U' . 'RU1Q' . 'T1JBU' . 'llfQ0F' . 'DS' . 'EU' . '=', '', 'NWM' . '4OGE=', 'J' . 'XMlcw' . '==', 'MDZlMDA4ZjdkYzY4Yj' . 'RiZDY5' . 'NTg' . '=', 'c' . 'm92', 'a29mZl9TSVR' . 'FRVhQSVJFREF' . 'URU' . '1BUEVS', 'bQ==', 'ZA==', 'WQ==', 'U2l' . '0' . 'ZUV4cGlyZURhdGVfcm92ZXJfd' . 'Glua29mZ' . 'g==', 'c2FsZQ==', '' . 'c2' . 'FsZSBtb' . '2R' . '1bGUgbm90IGZvdW5k', 'Rk9ST' . 'V9Q' . 'QV' . 'JB' . 'TVM' . '=', 'UkVBRFlfVE9fUE' . 'FZ', 'T' . '3JkZ' . 'XJJZD0=', 'T1J' . 'ERVJfSUQ=', 'IG' . 'dvb2Qgc' . 'GF5bW' . 'Vu' . 'dA=' . '=', 'Uk' . 'VBRFlf' . 'V' . 'E9fUE' . 'FZ', 'TUV' . 'TU0FHRQ==', '' . 'T3JkZXJ' . 'JZ' . 'D0' . '=', '' . 'T1JERVJfS' . 'UQ=', 'IA' . '==', 'VG9rZW' . '4=', 'U0hPUF9TRUN' . 'SRV' . 'R' . 'f' . 'V09SRA' . '==', 'VG9r' . 'ZW' . '4=', 'U0hPUF' . '9TRUNSRVRfV09' . 'S' . 'RA==', 'Q0F' . 'OX1BSS' . 'U5' . 'UX0' . 'NIRU' . 'NL', 'WQ' . '=' . '=', 'VEFYQVRJT04=', 'TkRT', 'UmVj' . 'ZWlwdA=' . '=', 'SW5' . 'pdCBn' . 'ZXRSZWNlaXB0' . 'OiA=', 'SXRlbXM=', '' . 'VG' . 'F4YXRpb2' . '4=', 'VEFYQVRJT0' . '4' . '=', '' . 'U' . 'k' . 'VD' . 'SVB' . 'JRU' . '5UX0l' . 'E', 'ZW1h' . 'aWw=', 'RW1' . 'haW' . 'w' . '=', 'UkV' . 'D' . 'S' . 'VBJRU5UX0lE', 'cGhvb' . 'mU=', 'U' . 'GhvbmU' . '=', 'U' . 'FJ' . 'JQ0' . 'U' . '=', 'SXRlbXM' . '=', 'TmFtZQ==', 'Tk' . 'FNR' . 'Q=' . '=', 'VVRG' . 'LTg=', 'UHJpY' . '2' . 'U=', '' . 'UFJJ' . 'Q0U=', 'UXVhbnRp' . 'dHk=', '' . 'UVVBTlRJVFk=', 'QW' . '1vd' . 'W50', 'UFJJQ' . '0U=', 'UV' . 'VBTlRJVFk=', 'VGF' . '4', '' . 'TkRT', '' . 'ZG' . 'Vs' . 'a' . 'XZlcnkgc3' . 'l' . 'zdGVtIG5vd' . 'CB' . 'mb3V' . 'uZA==', 'SXRlb' . 'XM=', '' . 'TmF' . 'tZ' . 'Q==', 'TkF' . 'NRQ' . '==', 'VVR' . 'GLT' . 'g=', 'UHJpY2' . 'U=', '' . 'U' . 'XVhbnRpdH' . 'k=', '' . 'QW1vdW50', 'V' . 'GF4', 'TkRT', 'YWZ0' . 'Z' . 'XJC' . 'dWlsZFJ' . 'lY' . '2V' . 'pcHQ=', 'Zmlsd' . 'GVy', 'PU' . 'NPRE' . 'U=', 'UEFSRU5UX' . '0' . 'l' . 'E', 'UEFSRU5U' . 'X0lE', '' . 'c2V' . 's' . 'ZWN0', 'T' . 'kF' . 'NRQ==', 'TkFNRQ' . '==', 'TkFNR' . 'Q=' . '=', 'IC' . 'g=', 'TkFNRQ==', 'KQ==', 'RE' . 'F' . 'UQ' . 'Q=' . '=', 'UmV' . 'jZW' . 'l' . 'w' . 'dA==', 'UGFzc3d' . 'v' . 'cmQ=', '', 'c2hh' . 'MjU2', 'c' . 'm92ZXJf' . 'dGlua29' . 'mZl9PTER' . 'T' . 'SVRFRVhQSVJ' . 'FREFURQ' . '=' . '=', 'ZXhwaXJl' . 'X21lc3NfY3Vzd' . 'G9tMg' . '==');
        return base64_decode($_2124549413[$_1813418007]);
    }
};



use Bitrix\Sale\Payment;
use Sale\Handlers\PaySystem\rover_tinkoffHandler;
use Bitrix\Main\Loader;
use Rover\Tinkoff\Log;
use \Bitrix\Sale\Order;
use \Rover\Tinkoff\OrderProps;
use \Bitrix\Sale\Delivery\Services\Table as DeliveryServices;

if (!Loader::includeModule('sale')) throw new \Bitrix\Main\SystemException('sale module not found');



class RoverTinkoffHelper
{
    public static function getExtraParams(rover_tinkoffHandler $data, $params, Payment $payment)
    {
        Log::note('OrderId=' . $params['ORDER_ID'] . '; Price=' . round($params['SHOULD_PAY'] * 100));
        try {
            $extraParams['FORM_PARAMS'] = $data->initPayment($payment);
            $extraParams['READY_TO_PAY'] = true;
            Log::note('OrderId=' . $params['ORDER_ID'] . 'good payment');
        } catch (\Exception $message) {
            $extraParams['READY_TO_PAY'] = false;
            $extraParams['MESSAGE'] = $message->getMessage();
            Log::error('OrderId=' . $params['ORDER_ID'] . ___385691105(51) . $message);
        }
        return $extraParams;
    }

    public static function getRefundParams($arParams, $arFields)
    {
        $_469988118 = array('TerminalKey' => $arParams['TERMINAL_ID'], 'PaymentId' => $arFields['PAY_VOUCHER_NUM'],);
        $_469988118['Token'] = self::dataPay($_469988118, trim($arParams['SHOP_SECRET_WORD']));
        return $_469988118;
    }

    public static function getInitParams(Payment $payment, array $arParams)
    {
        $_469988118 = array('TerminalKey' => trim($arParams['TERMINAL_ID']), 'Amount' => round($arParams['SHOULD_PAY'] * 100), 'OrderId' => trim($arParams['ORDER_ID']),);
        $_469988118['Token'] = self::dataPay($_469988118, trim($arParams['SHOP_SECRET_WORD']));
        $_1149267613 = $payment->getPaySystem();
        if (($_1149267613->getField('CAN_PRINT_CHECK') == 'Y') && (!empty($arParams['TAXATION'])) && (!empty($arParams['NDS']))) try {
            $_469988118['Receipt'] = self::dataOrder($arParams);
        } catch (\Exception $error) {
            Log::error('Init getReceipt:' . $error->getMessage());
        }
        return $_469988118;
    }

    private static function dataOrder($arParams)
    {
        $order = Order::loadByAccountNumber($arParams['ORDER_ID']);
        if (!$order) return [];
        $collection = $order->getPropertyCollection();
        $_85918530 = array('Items' => array(), 'Taxation' => $arParams['TAXATION'],);
        if (($arParams['RECIPIENT_ID'] != 'email') && ($collection->getUserEmail())) $_85918530['Email'] = $collection->getUserEmail()->getValue();
        if (($arParams['RECIPIENT_ID'] != 'phone') && ($collection->getPhone())) $_85918530['Phone'] = $collection->getPhone()->getValue();
        $_1958815742 = $order->getBasket()->getBasketItems();
        foreach ($_1958815742 as $_1250627000) {
            $_1575558518 = $_1250627000->getFieldValues();
            if ($_1575558518['PRICE'] <= 0) continue;
            $_85918530['Items'][] = array('Name' => substr(mb_convert_encoding($_1575558518['NAME'], 'UTF-8', LANG_CHARSET), 0, 64), 'Price' => round($_1575558518['PRICE'] * 100), 'Quantity' => round($_1575558518['QUANTITY'], 3, PHP_ROUND_HALF_UP), 'Amount' => round($_1575558518['PRICE'] * $_1575558518['QUANTITY'] * 100), 'Tax' => $arParams['NDS']);
        }
        $newPrice = $order->getDeliveryPrice();
        if ($newPrice) {
            $_1926417395 = self::delivery($order);
            if (!$_1926417395) throw new \Bitrix\Main\SystemException('delivery system not found');
            $_85918530['Items'][] = array('Name' => substr(mb_convert_encoding($_1926417395['NAME'], 'UTF-8', LANG_CHARSET), 0, 64), 'Price' => round($newPrice * 100), 'Quantity' => 1, 'Amount' => round($newPrice * 100), 'Tax' => $arParams['NDS'],);
        }
        $_487024601 = \Rover\Tinkoff\Event::run('afterBuildReceipt', $order, $_85918530, $arParams);
        if (isset($_487024601[1])) return $_487024601[1];
        return [];
    }

    private static function delivery(Order $order)
    {
        $deliveryIds = reset($order->getDeliverySystemId());
        $array = null;
        if (intval($deliveryIds)) $array = DeliveryServices::getRowById($deliveryIds); elseif (strlen($deliveryIds)) {
            $array = DeliveryServices::getRow(array('filter' => array('=CODE' => $deliveryIds)));
        }
        if (isset($array['PARENT_ID'])) {
            $deliveryDat = DeliveryServices::getByPrimary($array['PARENT_ID'], array('select' => array('NAME')))->fetch();
            $array['NAME'] = $deliveryDat['NAME'] . '(' . $array['NAME'] . ')';
        }
        return $array;
    }

    private static function dataPay(array $params, $password)
    {
        $data = $params;
        unset($data['DATA']);
        unset($data['Receipt']);
        $data['Password'] = $password;
        ksort($data);
        $_1292546250 = implode(___385691105(110), array_values($data));
        return hash('sha256', $_1292546250);
    }
};

?>